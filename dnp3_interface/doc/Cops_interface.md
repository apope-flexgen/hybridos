
DNP3 Cops Interface

p. wilshire 03_23_2023



The cops interface is required to allow the dnp3 interface components to communicate with the cops system monitor.

TODO <<define the id of the process >>
The dnp3 server will subscribe to /cops/dnp3_server.some_config to allow the cops process to exchange information with the preocess.


```
subs /dnp3_server.some_config/
```

incoming cops message will be

```
set /dnp3_server.some_config/cops/cops_heartbeat  1234
```


The response will be sent to the replyto in the incoming message.
Or to a config based cops_reply uri in the system component.





More information on the cops system is in this document.

https://flexgen.atlassian.net/wiki/spaces/API/pages/9502767/COPS+-+Configuration





The outgoing message from the dnp3_servr ( or client) will contain the following informtion.

```


Method:       set
Uri:          /cops/heartbeat/dnp3_server.some_config
ReplyTo:      (null)
Process Name: dnp3_controller@config
Username:     hybridos
Body:         {
                  "cops_heartbeat":81,
                  "pid":9076,
                  "version_tag":"4d5e917",
                  "version_commit":"4d5e917",
                  "version_build":"372"
              }
```


The git information is derived from the package_utilites/version.sh which is placed in the following object files

```
git_branch.o
git_build.o
git_commit.o
git_tag.o
```


These are generated by the following script segment

```
# capture working branch
branch=$(git branch | grep \* | cut -d ' ' -f2)
echo -e "branch:\t\t$branch"
rm -f GIT_BRANCH
echo "$branch" >> GIT_BRANCH
objcopy --input binary \
            --output-target elf64-x86-64 \
            --binary-architecture i386 GIT_BRANCH git_branch.o

# capture current commit
commit=$(git log --pretty=format:'%h' -n 1)
echo -e "commit:\t\t$commit"
rm -f GIT_COMMIT
echo "$commit" >> GIT_COMMIT
objcopy --input binary \
            --output-target elf64-x86-64 \
            --binary-architecture i386 GIT_COMMIT git_commit.o

# capture latest tag
if git describe --match "v*" --abbrev=0 --tags HEAD &> /dev/null ; then
    tag_long=$(git describe --match "v*" --abbrev=0 --tags HEAD)
    if [[ $tag_long == "v"* ]]; then tag=${tag_long:1}; fi # (v1.0.0) -> (1.0.0)
    if [[ $tag_long == *"-"* ]]; then tag=`echo $tag | sed 's/-/./g'`; fi # (1.0.0-rc) - > (1.0.0.rc)
elif git describe --abbrev=0 --tags HEAD &> /dev/null ; then
    tag=$(git describe --abbrev=0 --tags HEAD)
else
    tag=$commit # no tag info, use abbreviated commit hash
fi

mkdir -p build/release_obj
cp git*.o build/release_obj

```

The source code (dnp3_client) extracts the git information at build time as follows.
```
file: version.cpp
/*
 * Version.cpp
 *
 *  Created on: 2021-02-03
 *      Author: Anirudh Mulukutla
 */
#include <stdio.h>
#include <cstdlib>

#include <version.h>

// GIT_BUILD
extern char _binary_GIT_BUILD_start;
extern char _binary_GIT_BUILD_end;

// GIT_COMMIT
extern char _binary_GIT_COMMIT_start;
extern char _binary_GIT_COMMIT_end;

// GIT_TAG
extern char _binary_GIT_TAG_start;
extern char _binary_GIT_TAG_end;

Version::Version ()
{
    build = NULL;
    commit = NULL;
    tag = NULL;
}

Version::~Version ()
{
    if (build != NULL) delete[] build;
    if (commit != NULL) delete[] commit;
    if (tag != NULL) delete[] tag;
}

void Version::init(void) {
    build = extract(build, &_binary_GIT_BUILD_start, &_binary_GIT_BUILD_end);
    commit = extract(commit, &_binary_GIT_COMMIT_start, &_binary_GIT_COMMIT_end);
    tag = extract(tag, &_binary_GIT_TAG_start, &_binary_GIT_TAG_end);
}

char* Version::extract(char* info, char* start, char* end)
{
    int iter = 0;
    char* p_iter = start;
    while ( p_iter != end ) {
        putchar(*p_iter++);
        iter++;
    }
    info = new char[iter];
    snprintf(info, iter, start);
    return info;
}

char* Version::get_build(void)
{
    return build;
}

char* Version::get_commit(void)
{
    return commit;
}

char* Version::get_tag(void)
{
    return tag;
}
```

```
// file version.h
/*
 * vesion.h
 *
 *  Created on: 2021-02-03
 *      Author: Anirudh Mulukutla
 */

#ifndef VERSION_H_
#define VERSION_H_

#include <string>

class Version
{
public:
    Version ();
    virtual ~Version ();
    
    void init(void); // initialization, call after object creation

    char* get_build(void);
    char* get_commit(void);
    char* get_tag(void);

private:
    char* build;
    char* commit;
    char* tag;

    char* extract(char* info, char* start, char* end);
};

#endif /* VERSION_H_ */
```



```
main.cpp

    // access version info
    #include <version.h>

    Version* version = new Version();
    version->init();
    sys->version = version;
    printf("build: %s\n",  version->get_build());
    printf("commit: %s\n", version->get_commit());
    printf("tag: %s\n",    version->get_tag());

```

```
  
  sys->cjv = cJSON_CreateObject();
  cJSON_AddNumberToObject(sys->cjv, "cops_heartbeat", sys->cop_heartbeat);         // new variable cop_heartbeat         
  cJSON_AddNumberToObject(sys->cjv, "pid",            sys->pid);                   // new variable pid    
  cJSON_AddStringToObject(sys->cjv, "version_tag",    sys->version->get_tag());    // new variable    version 
  cJSON_AddStringToObject(sys->cjv, "version_commit", sys->version->get_commit()); // new variable     
  cJSON_AddStringToObject(sys->cjv, "version_build",  sys->version->get_build());  // new variable     

```

```
  // here is the fims message capture
  else if (strncmp(pfrags[1], "cops", strlen("cops")) == 0)
     build_JSON_cops(sys);
```


```
In the Makefile
OBJECTS += version.o git_build.o git_commit.o git_tag.o Configurator.o LDSS.o Input_Sources.o Logger.o

#and we use scripts/git_info.sh to create these files if needed

```