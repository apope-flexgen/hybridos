- hosts: localhost
  become: true

  tasks:
  - name: "Include Vars"
    include_vars: sce_vars.yml
    name: sce_vars
  
  - name: "Gather Modbus Echoes List"
    find:
      paths: "{{ cfg_path }}/echo"
      patterns: "*_echo.json"
      file_type: file
    register: echoes

  - name: Setting Echo files as list to run Echoes
    set_fact:
      echo_list: "{{ echoes.files | map(attribute='path') | map('regex_replace','^.*/(.*)$','\\1') | list }}"

  - name: "Run Modbus Echoes"
    systemd:
      name: echo@{{ item }}
      state: started
      daemon_reload: yes
      enabled: true
    with_items:
      - "{{ echo_list }}"
  
  - name: "Gather Modbus Server List"
    find:
      paths: "{{ cfg_path }}/modbus_server"
      patterns: "*_server.json"
      file_type: file
    register: servers
  
  - name: Setting Modbus Server files as list to run Modbus Servers
    set_fact:
      mbserver_list: "{{ servers.files | map(attribute='path') | map('regex_replace','^.*/(.*)$','\\1') | list }}"

  - name: "Run Modbus Servers"
    systemd:
      name: modbus_server@{{ item }}
      state: started
      daemon_reload: yes
      enabled: true
    with_items:
      - "{{ mbserver_list }}"

