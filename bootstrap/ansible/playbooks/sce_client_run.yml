- hosts: localhost
  become: true

  tasks:
  - name: "Include Vars"
    include_vars: sce_vars.yml
    name: sce_vars

  - name: "Gather Modbus Clients List"
    find:
      paths: "{{ cfg_path }}/modbus_client"
      patterns: "flexgen_ess_*_modbus_client.json"
      file_type: file
    register: clients

  - name: "Setting Client files as list to run Clients"
    set_fact:
      client_list: "{{ clients.files | map(attribute='path') | map('regex_replace','^.*/(.*)$','\\1') | list }}"

  - name: "Run Modbus Clients"
    systemd:
      name: modbus_client@{{ item }}
      state: started
      daemon_reload: yes
      enabled: true
    with_items:
      - "{{ client_list }}"
